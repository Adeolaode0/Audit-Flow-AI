{% extends "base.html" %}

{% block title %}Evidence Testing - Audit Flow AI{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">üß™ Evidence Testing</h1>
        <p class="text-gray-600">Upload and analyze audit evidence with AI-powered analysis</p>
    </div>

    <!-- Control Information Display -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Control Objective -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">üéØ Control Objective</h3>
            <p id="controlObjectiveDisplay" class="text-gray-700 bg-gray-50 p-4 rounded-md">Loading control objective...</p>
        </div>

        <!-- Risk Statement -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">‚ö†Ô∏è Risk Statement</h3>
            <p id="riskStatementDisplay" class="text-gray-700 bg-gray-50 p-4 rounded-md">Loading risk statement...</p>
        </div>
    </div>

    <!-- Control Description Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">üìã Control Description</h3>
        <p id="controlDescriptionDisplay" class="text-gray-700 bg-gray-50 p-4 rounded-md">Loading control description...</p>
    </div>

    <!-- Walkthrough Discussion Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">üí¨ Walkthrough Discussion</h3>
        <p id="walkthroughDiscussionDisplay" class="text-gray-700 bg-gray-50 p-4 rounded-md">Loading walkthrough discussion...</p>
    </div>

    <!-- Test Attributes Container -->
    <div id="testAttributesContainer" class="space-y-6">
        <!-- Initial Test Attribute -->
        <div class="test-attribute bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">üéØ Test Attribute</h3>
                <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Attribute #1</span>
            </div>
            
            <!-- Test Script -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Test Script</label>
                <textarea 
                    class="testScript w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-audit-blue focus:border-audit-blue transition-colors duration-200" 
                    rows="4" 
                    placeholder="Test Attribute - Paste the test script here..."
                ></textarea>
            </div>
            
            <!-- Evidence Summary -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Evidence Summary</label>
                <textarea 
                    class="evidenceSummary w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-audit-blue focus:border-audit-blue transition-colors duration-200" 
                    rows="4" 
                    placeholder="Provide instructions or notes about what the AI should look for in the uploaded evidence..."
                ></textarea>
            </div>
            
            <!-- File Upload -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Evidence Files</label>
                <div class="fileUploadContainer space-y-3">
                    <input 
                        type="file" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-audit-blue focus:border-audit-blue transition-colors duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-audit-blue file:text-white hover:file:bg-blue-700" 
                        name="evidence" 
                        multiple
                    >
                    <button class="addFileButton bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                        üìé Add More Files
                    </button>
                </div>
            </div>
            
            <button class="analyzeButton bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-md transition-colors duration-200 mb-4">
                üîç Analyze Evidence
            </button>
            
            <!-- Analysis Results -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Analysis Narrative</label>
                <textarea 
                    class="analysisNarrative w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" 
                    rows="6" 
                    readonly 
                    placeholder="Analysis Narrative will appear here..."
                ></textarea>
            </div>
            
            <!-- Manual Verdict Selection -->
            <div class="verdict-section hidden">
                <h4 class="text-md font-semibold text-gray-900 mb-3">Select Verdict:</h4>
                <div class="verdict-buttons flex gap-3 mb-3">
                    <button class="passButton bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                        ‚úÖ Pass
                    </button>
                    <button class="failButton bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                        ‚ùå Fail
                    </button>
                </div>
                <div class="verdict text-center font-semibold"></div>
            </div>
        </div>
    </div>

    <!-- Add Another Attribute Button -->
    <div class="text-center my-6">
        <button id="addAttributeButton" class="bg-audit-blue hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-md transition-colors duration-200">
            ‚ûï Add Another Attribute
        </button>
    </div>

    <!-- Overall Rationale Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Overall Test Conclusion</h3>
        
        <button id="generateRationaleButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-3 px-6 rounded-md transition-colors duration-200 mb-4">
            üìù Generate Rationale Supporting Conclusion
        </button>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Overall Rationale</label>
            <textarea 
                id="overallRationale" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" 
                rows="8" 
                readonly 
                placeholder="Overall rationale will appear here after generating..."
            ></textarea>
        </div>
        
        <!-- Rationale Action Buttons -->
        <div id="rationaleActions" class="hidden flex gap-3 mb-4">
            <button id="copyRationaleButton" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                üìã Copy to Clipboard
            </button>
            <button id="downloadPdfButton" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                üìÑ Download Report
            </button>
        </div>
        
        <div id="overallVerdictSection" class="hidden text-center">
            <h4 class="text-md font-semibold text-gray-900 mb-2">Overall Test Result:</h4>
            <div id="overallVerdict" class="text-lg font-bold"></div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="evidenceLoading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center">
            <svg class="animate-spin h-5 w-5 text-purple-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-purple-600 font-medium">Analyzing Evidence...</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300">
        <span id="toastMessage"></span>
    </div>

    <!-- Navigation -->
    <div class="mt-8 bg-gray-50 rounded-lg p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Navigation</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <a href="/" class="block p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow duration-200">
                <h4 class="font-medium text-gray-900">üìù Main Form</h4>
                <p class="text-sm text-gray-600 mt-1">Control description and walkthrough rewriting</p>
            </a>
            <a href="/api/health" target="_blank" class="block p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow duration-200">
                <h4 class="font-medium text-gray-900">üè• API Health Check</h4>
                <p class="text-sm text-gray-600 mt-1">Verify OpenAI API connection status</p>
            </a>
        </div>
    </div>
</div>

<script>
// Load control information from localStorage on page load
window.addEventListener("load", () => {
    const savedData = localStorage.getItem("auditData");
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            const controlObjective = data.control_objective || "No control objective available.";
            const riskStatement = data.risk_statement || "No risk statement available.";
            const controlDescription = data.control_description || "No control description available.";
            const walkthroughDiscussion = data.walkthrough_discussion || "No walkthrough discussion available.";
            
            document.getElementById("controlObjectiveDisplay").innerText = controlObjective;
            document.getElementById("riskStatementDisplay").innerText = riskStatement;
            document.getElementById("controlDescriptionDisplay").innerText = controlDescription;
            document.getElementById("walkthroughDiscussionDisplay").innerText = walkthroughDiscussion;
        } catch (error) {
            console.error("Error loading saved data:", error);
            document.getElementById("controlObjectiveDisplay").innerText = "Error loading control objective.";
            document.getElementById("riskStatementDisplay").innerText = "Error loading risk statement.";
            document.getElementById("controlDescriptionDisplay").innerText = "Error loading control description.";
            document.getElementById("walkthroughDiscussionDisplay").innerText = "Error loading walkthrough discussion.";
        }
    } else {
        document.getElementById("controlObjectiveDisplay").innerText = "No control objective found. Please go back and save your audit data first.";
        document.getElementById("riskStatementDisplay").innerText = "No risk statement found. Please go back and save your audit data first.";
        document.getElementById("controlDescriptionDisplay").innerText = "No control description found. Please go back and save your audit data first.";
        document.getElementById("walkthroughDiscussionDisplay").innerText = "No walkthrough discussion found. Please go back and save your audit data first.";
    }
});

// Toast notification function
function showToast(message) {
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toastMessage");
    toastMessage.textContent = message;
    toast.classList.remove("hidden");
    setTimeout(() => {
        toast.classList.add("hidden");
    }, 3000);
}

// Function to copy rationale to clipboard
function copyRationaleToClipboard() {
    const rationaleText = document.getElementById("overallRationale").value;
    if (!rationaleText) {
        alert("No rationale to copy.");
        return;
    }
    
    navigator.clipboard.writeText(rationaleText).then(() => {
        const copyButton = document.getElementById("copyRationaleButton");
        const originalText = copyButton.textContent;
        copyButton.textContent = "‚úÖ Copied!";
        copyButton.classList.remove("bg-blue-600", "hover:bg-blue-700");
        copyButton.classList.add("bg-green-600", "hover:bg-green-700");
        
        setTimeout(() => {
            copyButton.textContent = originalText;
            copyButton.classList.remove("bg-green-600", "hover:bg-green-700");
            copyButton.classList.add("bg-blue-600", "hover:bg-blue-700");
        }, 2000);
    }).catch(err => {
        alert("Failed to copy to clipboard: " + err.message);
    });
}

// Function to download rationale as report
async function downloadRationalePDF() {
    const rationaleText = document.getElementById("overallRationale").value;
    const overallVerdict = document.getElementById("overallVerdict").innerText;
    const controlObjective = document.getElementById("controlObjectiveDisplay").innerText;
    const riskStatement = document.getElementById("riskStatementDisplay").innerText;
    const controlDescription = document.getElementById("controlDescriptionDisplay").innerText;
    const walkthroughDiscussion = document.getElementById("walkthroughDiscussionDisplay").innerText;
    
    if (!rationaleText) {
        alert("No rationale to download.");
        return;
    }
    
    // Collect test attribute data for the report
    const testAttributes = document.querySelectorAll(".test-attribute");
    let attributesData = [];
    
    testAttributes.forEach((attribute, index) => {
        const testScript = attribute.querySelector(".testScript").value.trim();
        const evidenceSummary = attribute.querySelector(".evidenceSummary").value.trim();
        const analysisNarrative = attribute.querySelector(".analysisNarrative").value.trim();
        const verdictElement = attribute.querySelector(".verdict");
        const verdictText = verdictElement.innerText.trim();
        
        if (testScript && analysisNarrative && verdictText.includes("Final Verdict:")) {
            const verdict = verdictText.includes("Pass") ? "Pass" : "Fail";
            attributesData.push({
                index: index + 1,
                testScript: testScript,
                evidenceSummary: evidenceSummary,
                analysisNarrative: analysisNarrative,
                verdict: verdict
            });
        }
    });
    
    const downloadButton = document.getElementById("downloadPdfButton");
    downloadButton.disabled = true;
    downloadButton.textContent = "üîÑ Generating Report...";
    
    try {
        // Create a comprehensive text report
        const reportContent = `
AUDIT TEST REPORT
Generated: ${new Date().toLocaleString()}
=========================================

CONTROL OBJECTIVE:
${controlObjective}

RISK STATEMENT:
${riskStatement}

CONTROL DESCRIPTION:
${controlDescription}

WALKTHROUGH DISCUSSION:
${walkthroughDiscussion}

TEST ATTRIBUTES ANALYSIS:
=========================================

${attributesData.map(attr => `
ATTRIBUTE ${attr.index}:
------------------
Test Script: ${attr.testScript}

Evidence Summary: ${attr.evidenceSummary}

Analysis Narrative: ${attr.analysisNarrative}

Verdict: ${attr.verdict}

`).join('\n')}

OVERALL CONCLUSION:
=========================================

${rationaleText}

FINAL VERDICT:
${overallVerdict}

=========================================
Report generated by Audit Flow AI
        `;
        
        // Create and download text file
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Audit_Test_Report_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast("Report downloaded successfully!");
        
    } catch (error) {
        alert("Error generating report: " + error.message);
    } finally {
        downloadButton.disabled = false;
        downloadButton.textContent = "üìÑ Download Report";
    }
}

// Client-side rationale generation function
function generateClientSideRationale(attributesData, overallResult, controlObjective, riskStatement, controlDescription, walkthroughDiscussion, hasFailures) {
    const failedAttributes = attributesData.filter(attr => attr.verdict === "Fail");
    const passedAttributes = attributesData.filter(attr => attr.verdict === "Pass");
    
    let rationale = `OVERALL TEST CONCLUSION: ${overallResult}\n\n`;
    
    rationale += `CONTROL ASSESSMENT:\n`;
    rationale += `Based on our comprehensive testing of the control "${controlDescription.substring(0, 200)}${controlDescription.length > 200 ? '...' : ''}", `;
    
    if (overallResult === "FAIL") {
        rationale += `we conclude that the control is NOT operating effectively. `;
        rationale += `Our testing revealed that ${failedAttributes.length} out of ${attributesData.length} test attributes failed, `;
        rationale += `which indicates significant deficiencies in the control operation that prevent us from relying on this control.\n\n`;
        
        rationale += `FAILED ATTRIBUTES ANALYSIS:\n`;
        failedAttributes.forEach(attr => {
            rationale += `‚Ä¢ Attribute ${attr.index} - FAILED:\n`;
            rationale += `  Test Focus: ${attr.testScript.substring(0, 150)}${attr.testScript.length > 150 ? '...' : ''}\n`;
            rationale += `  Key Finding: ${attr.analysisNarrative.substring(0, 200)}${attr.analysisNarrative.length > 200 ? '...' : ''}\n`;
            rationale += `  Impact: This failure indicates a breakdown in the control process that compromises the control objective.\n\n`;
        });
        
        if (passedAttributes.length > 0) {
            rationale += `PASSED ATTRIBUTES:\n`;
            rationale += `While ${passedAttributes.length} attribute(s) did pass testing, the presence of any failed attributes requires an overall FAIL conclusion as all control components must function effectively.\n\n`;
        }
    } else {
        rationale += `we conclude that the control IS operating effectively. `;
        rationale += `Our testing successfully validated all ${attributesData.length} test attributes, demonstrating consistent and reliable control operation across all tested scenarios.\n\n`;
        
        rationale += `SUCCESSFUL ATTRIBUTES ANALYSIS:\n`;
        passedAttributes.forEach(attr => {
            rationale += `‚Ä¢ Attribute ${attr.index} - PASSED:\n`;
            rationale += `  Test Focus: ${attr.testScript.substring(0, 150)}${attr.testScript.length > 150 ? '...' : ''}\n`;
            rationale += `  Validation: ${attr.analysisNarrative.substring(0, 200)}${attr.analysisNarrative.length > 200 ? '...' : ''}\n`;
            rationale += `  Result: Evidence supports effective control operation for this attribute.\n\n`;
        });
    }
    
    rationale += `PROFESSIONAL AUDIT OPINION:\n`;
    rationale += `Based on the evidence reviewed, analysis performed, and testing procedures executed, the control `;
    if (overallResult === "PASS") {
        rationale += `can be relied upon to achieve its intended control objective. The control demonstrates:\n`;
        rationale += `‚Ä¢ Consistent operation across all tested scenarios\n`;
        rationale += `‚Ä¢ Adequate design to address the identified risks\n`;
        rationale += `‚Ä¢ Effective implementation in the control environment\n`;
        rationale += `‚Ä¢ Reliable evidence of control performance\n\n`;
        rationale += `We have no exceptions to report and consider this control to be operating effectively.`;
    } else {
        rationale += `cannot be relied upon to achieve its intended control objective. The identified deficiencies include:\n`;
        rationale += `‚Ä¢ Failed control components that compromise overall effectiveness\n`;
        rationale += `‚Ä¢ Inadequate control performance in critical areas\n`;
        rationale += `‚Ä¢ Evidence of control breakdowns or exceptions\n`;
        rationale += `‚Ä¢ Risk that control objectives may not be met\n\n`;
        rationale += `This represents a control deficiency that requires management attention and remediation.`;
    }
    
    rationale += `\n\nTesting completed on ${new Date().toLocaleDateString()} by Audit Flow AI.`;
    
    return rationale;
}

// Function to generate overall rationale
async function generateOverallRationale() {
    const testAttributes = document.querySelectorAll(".test-attribute");
    const controlObjective = document.getElementById("controlObjectiveDisplay").innerText;
    const riskStatement = document.getElementById("riskStatementDisplay").innerText;
    const controlDescription = document.getElementById("controlDescriptionDisplay").innerText;
    const walkthroughDiscussion = document.getElementById("walkthroughDiscussionDisplay").innerText;
    
    // Collect data from all test attributes
    let attributesData = [];
    let hasFailures = false;
    let allVerdictsMade = true;
    
    testAttributes.forEach((attribute, index) => {
        const testScript = attribute.querySelector(".testScript").value.trim();
        const evidenceSummary = attribute.querySelector(".evidenceSummary").value.trim();
        const analysisNarrative = attribute.querySelector(".analysisNarrative").value.trim();
        const verdictElement = attribute.querySelector(".verdict");
        
        // Check if verdict has been made
        const verdictText = verdictElement.innerText.trim();
        if (!verdictText || !verdictText.includes("Final Verdict:")) {
            allVerdictsMade = false;
            return;
        }
        
        // Determine if this attribute passed or failed
        const isPass = verdictText.includes("Pass");
        const isFail = verdictText.includes("Fail");
        
        if (isFail) {
            hasFailures = true;
        }
        
        attributesData.push({
            index: index + 1,
            testScript: testScript,
            evidenceSummary: evidenceSummary,
            analysisNarrative: analysisNarrative,
            verdict: isPass ? "Pass" : "Fail"
        });
    });
    
    // Validation
    if (attributesData.length === 0) {
        alert("Please complete at least one test attribute with analysis and verdict.");
        return;
    }
    
    if (!allVerdictsMade) {
        alert("Please complete analysis and select verdicts for all test attributes before generating overall rationale.");
        return;
    }
    
    // Determine overall result
    const overallResult = hasFailures ? "FAIL" : "PASS";
    
    // Show loading state
    const generateButton = document.getElementById("generateRationaleButton");
    generateButton.disabled = true;
    generateButton.textContent = "üîÑ Generating Rationale...";
    
    try {
        // Generate rationale using client-side function
        const rationaleText = generateClientSideRationale(
            attributesData, 
            overallResult, 
            controlObjective,
            riskStatement,
            controlDescription, 
            walkthroughDiscussion, 
            hasFailures
        );
        
        document.getElementById("overallRationale").value = rationaleText;
        
        // Show overall verdict
        const overallVerdictElement = document.getElementById("overallVerdict");
        const overallVerdictSection = document.getElementById("overallVerdictSection");
        
        if (overallResult === "PASS") {
            overallVerdictElement.innerHTML = `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">‚úÖ PASS</span>`;
        } else {
            overallVerdictElement.innerHTML = `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">‚ùå FAIL</span>`;
        }
        
        overallVerdictSection.classList.remove("hidden");
        
        // Show the action buttons
        document.getElementById("rationaleActions").classList.remove("hidden");
        
        showToast("Rationale generated successfully!");
        
    } catch (error) {
        console.error("Error generating rationale:", error);
        alert("Error generating rationale: " + error.message);
    } finally {
        // Reset button state
        generateButton.disabled = false;
        generateButton.textContent = "üìù Generate Rationale Supporting Conclusion";
    }
}

// Function to handle evidence analysis
async function analyzeEvidence(testAttribute) {
    const testScript = testAttribute.querySelector(".testScript").value.trim();
    const evidenceSummary = testAttribute.querySelector(".evidenceSummary").value.trim();
    const fileUploadContainer = testAttribute.querySelector(".fileUploadContainer");
    const files = fileUploadContainer.querySelectorAll("input[type='file']");
    const analyzeButton = testAttribute.querySelector(".analyzeButton");
    
    // Get control information from the page
    const controlObjective = document.getElementById("controlObjectiveDisplay").innerText;
    const riskStatement = document.getElementById("riskStatementDisplay").innerText;
    const controlDescription = document.getElementById("controlDescriptionDisplay").innerText;
    const walkthroughDiscussion = document.getElementById("walkthroughDiscussionDisplay").innerText;
    
    // Validation
    if (!testScript) {
        alert("Please enter a test script.");
        return;
    }
    if (!evidenceSummary) {
        alert("Please enter evidence summary/instructions.");
        return;
    }
    
    // Check if any files are selected
    let hasFiles = false;
    files.forEach(fileInput => {
        if (fileInput.files.length > 0) {
            hasFiles = true;
        }
    });
    
    if (!hasFiles) {
        alert("Please upload at least one evidence file.");
        return;
    }

    const formData = new FormData();
    formData.append("control_objective", controlObjective);
    formData.append("risk_statement", riskStatement);
    formData.append("control_description", controlDescription);
    formData.append("walkthrough_discussion", walkthroughDiscussion);
    formData.append("test_script", testScript);
    formData.append("evidence_summary", evidenceSummary);
    
    // AI Instructions with enhanced PII protection
    const analysisInstructions = `
You are a professional auditor. Your PRIMARY task is to validate the Evidence Summary comments by analyzing how the uploaded evidence supports the conclusions outlined in the Evidence Summary.

**CRITICAL PRIVACY & SCOPE REQUIREMENTS:**

**EVIDENCE SUMMARY VALIDATION FOCUS:**
- Evidence Summary Comments: "${evidenceSummary}"
- Test Attribute Scope: "${testScript}"
- YOUR GOAL: Validate and support the Evidence Summary conclusions with evidence findings

**STRICT PII PROTECTION RULES - NO EXCEPTIONS:**
1. **NEVER** include any names, email addresses, phone numbers, or personal identifiers
2. **NEVER** include specific dollar amounts, account numbers, or financial details
3. **NEVER** include addresses, locations, or geographic identifiers beyond general terms
4. **NEVER** include employee IDs, social security numbers, or personal data
5. **NEVER** include company names, client names, or vendor names
6. **NEVER** include specific dates that could identify transactions or events
7. **NEVER** include specific file names, usernames, or system identifiers
8. **USE GENERIC TERMS ONLY**: "the individual", "the transaction", "the document", "the system", "the process"

**ANALYSIS METHODOLOGY:**
1. **READ** the Evidence Summary comments as your primary guide
2. **SCAN** evidence files to find support for the Evidence Summary conclusions
3. **VALIDATE** whether the evidence supports what the Evidence Summary states
4. **FOCUS** only on evidence relevant to the Test Attribute scope
5. **IGNORE** any information outside the Test Attribute boundaries
6. **CONFIRM** the Evidence Summary findings using generic, non-identifying language

**OUTPUT REQUIREMENTS:**
Generate a professional audit narrative that:
- **VALIDATES** the Evidence Summary comments using evidence findings
- **EXPLAINS** how the evidence supports the Evidence Summary conclusions
- **USES** only generic, non-identifying language for all references
- **STAYS** strictly within the Test Attribute scope
- **FOCUSES** on confirming Evidence Summary observations
- **PROTECTS** all confidential and personal information

Remember: Your PRIMARY goal is validating Evidence Summary comments with evidence. NEVER reveal ANY PII or specific identifying information.
    `;
    
    formData.append("analysis_instructions", analysisInstructions);

    // Add files to the form data
    files.forEach(fileInput => {
        Array.from(fileInput.files).forEach(file => {
            formData.append("evidence", file);
        });
    });

    // Show loading state
    analyzeButton.disabled = true;
    analyzeButton.textContent = "üîÑ Analyzing Evidence...";
    document.getElementById("evidenceLoading").classList.remove("hidden");

    try {
        const response = await fetch("/api/analyze-evidence", {
            method: "POST",
            body: formData
        });

        const data = await response.json();
        
        if (data.analysis) {
            testAttribute.querySelector(".analysisNarrative").value = data.analysis;
            // Show the verdict buttons after analysis
            testAttribute.querySelector(".verdict-section").classList.remove("hidden");
            showToast("Evidence analyzed successfully!");
        } else {
            alert(data.error || "Failed to analyze evidence.");
        }
    } catch (error) {
        alert("Error: " + error.message);
    } finally {
        // Reset button state
        analyzeButton.disabled = false;
        analyzeButton.textContent = "üîç Analyze Evidence";
        document.getElementById("evidenceLoading").classList.add("hidden");
    }
}

// Function to set verdict
function setVerdict(testAttribute, verdict) {
    const verdictElement = testAttribute.querySelector(".verdict");
    const passButton = testAttribute.querySelector(".passButton");
    const failButton = testAttribute.querySelector(".failButton");
    
    // Reset button states
    passButton.classList.remove("bg-green-700");
    passButton.classList.add("bg-green-600");
    failButton.classList.remove("bg-red-700");
    failButton.classList.add("bg-red-600");
    
    if (verdict === "Pass") {
        passButton.classList.remove("bg-green-600");
        passButton.classList.add("bg-green-700");
        verdictElement.innerHTML = `Final Verdict: <span class="inline-flex items-center px-2 py-1 rounded text-sm font-medium bg-green-100 text-green-800">‚úÖ Pass</span>`;
    } else {
        failButton.classList.remove("bg-red-600");
        failButton.classList.add("bg-red-700");
        verdictElement.innerHTML = `Final Verdict: <span class="inline-flex items-center px-2 py-1 rounded text-sm font-medium bg-red-100 text-red-800">‚ùå Fail</span>`;
    }
    
    showToast(`Verdict set to ${verdict}`);
}

// Add event listeners for the initial test attribute
document.addEventListener("DOMContentLoaded", function() {
    // Add event listener for the initial Analyze Evidence button
    document.querySelector(".analyzeButton").addEventListener("click", async (event) => {
        event.preventDefault();
        const testAttribute = event.target.closest(".test-attribute");
        await analyzeEvidence(testAttribute);
    });

    // Add event listener for the first Add More Files button
    document.querySelector(".addFileButton").addEventListener("click", (event) => {
        event.preventDefault();
        const fileUploadContainer = event.target.closest(".fileUploadContainer");
        const newFileInput = document.createElement("input");
        newFileInput.type = "file";
        newFileInput.className = "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-audit-blue focus:border-audit-blue transition-colors duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-audit-blue file:text-white hover:file:bg-blue-700";
        newFileInput.name = "evidence";
        newFileInput.multiple = true;
        fileUploadContainer.insertBefore(newFileInput, fileUploadContainer.lastElementChild);
    });

    // Add event listeners for Pass/Fail buttons
    document.querySelector(".passButton").addEventListener("click", (event) => {
        const testAttribute = event.target.closest(".test-attribute");
        setVerdict(testAttribute, "Pass");
    });

    document.querySelector(".failButton").addEventListener("click", (event) => {
        const testAttribute = event.target.closest(".test-attribute");
        setVerdict(testAttribute, "Fail");
    });

    // Add event listener for overall rationale generation
    document.getElementById("generateRationaleButton").addEventListener("click", async (event) => {
        event.preventDefault();
        await generateOverallRationale();
    });

    // Add event listeners for copy and download buttons
    document.getElementById("copyRationaleButton").addEventListener("click", copyRationaleToClipboard);
    document.getElementById("downloadPdfButton").addEventListener("click", downloadRationalePDF);
});

// Add Another Test Attribute
document.getElementById("addAttributeButton").addEventListener("click", () => {
    const testAttributesContainer = document.getElementById("testAttributesContainer");
    const attributeCount = testAttributesContainer.children.length + 1;
    
    const newAttribute = document.createElement("div");
    newAttribute.className = "test-attribute bg-white rounded-lg shadow-sm border border-gray-200 p-6";
    newAttribute.innerHTML = `
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">üéØ Test Attribute</h3>
            <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Attribute #${attributeCount}</span>
        </div>
        
        <!-- Test Script -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Test Script</label>
            <textarea 
                class="testScript w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-audit-blue focus:border-audit-blue transition-colors duration-200" 
                rows="4" 
                placeholder="Test Attribute - Paste the test script here..."
            ></textarea>
        </div>
        
        <!-- Evidence Summary -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Evidence Summary</label>
            <textarea 
                class="evidenceSummary w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-audit-blue focus:border-audit-blue transition-colors duration-200" 
                rows="4" 
                placeholder="Provide instructions or notes about what the AI should look for in the uploaded evidence..."
            ></textarea>
        </div>
        
        <!-- File Upload -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Evidence Files</label>
            <div class="fileUploadContainer space-y-3">
                <input 
                    type="file" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-audit-blue focus:border-audit-blue transition-colors duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-audit-blue file:text-white hover:file:bg-blue-700" 
                    name="evidence" 
                    multiple
                >
                <button class="addFileButton bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                    üìé Add More Files
                </button>
            </div>
        </div>
        
        <button class="analyzeButton bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-md transition-colors duration-200 mb-4">
            üîç Analyze Evidence
        </button>
        
        <!-- Analysis Results -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Analysis Narrative</label>
            <textarea 
                class="analysisNarrative w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" 
                rows="6" 
                readonly 
                placeholder="Analysis Narrative will appear here..."
            ></textarea>
        </div>
        
        <!-- Manual Verdict Selection -->
        <div class="verdict-section hidden">
            <h4 class="text-md font-semibold text-gray-900 mb-3">Select Verdict:</h4>
            <div class="verdict-buttons flex gap-3 mb-3">
                <button class="passButton bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                    ‚úÖ Pass
                </button>
                <button class="failButton bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                    ‚ùå Fail
                </button>
            </div>
            <div class="verdict text-center font-semibold"></div>
        </div>
    `;
    testAttributesContainer.appendChild(newAttribute);

    // Add event listeners for the new attribute
    const analyzeButton = newAttribute.querySelector(".analyzeButton");
    analyzeButton.addEventListener("click", async (event) => {
        event.preventDefault();
        await analyzeEvidence(newAttribute);
    });

    const addFileButton = newAttribute.querySelector(".addFileButton");
    addFileButton.addEventListener("click", (event) => {
        event.preventDefault();
        const fileUploadContainer = event.target.closest(".fileUploadContainer");
        const newFileInput = document.createElement("input");
        newFileInput.type = "file";
        newFileInput.className = "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-audit-blue focus:border-audit-blue transition-colors duration-200 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-audit-blue file:text-white hover:file:bg-blue-700";
        newFileInput.name = "evidence";
        newFileInput.multiple = true;
        fileUploadContainer.insertBefore(newFileInput, fileUploadContainer.lastElementChild);
    });

    const passButton = newAttribute.querySelector(".passButton");
    passButton.addEventListener("click", (event) => {
        const testAttribute = event.target.closest(".test-attribute");
        setVerdict(testAttribute, "Pass");
    });

    const failButton = newAttribute.querySelector(".failButton");
    failButton.addEventListener("click", (event) => {
        const testAttribute = event.target.closest(".test-attribute");
        setVerdict(testAttribute, "Fail");
    });
    
    showToast("New test attribute added successfully!");
});
</script>
{% endblock %}
